<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Giftify</title>
<style>
  :root{
    --bg:#ffffff; --ink:#0b1220; --muted:#6b7280; --line:#e5e7eb;
    --card:#ffffff; --brand:#0ea5e9; --brand-ink:#0369a1; --ok:#16a34a; --err:#dc2626;
    --radius:18px; --shadow:0 8px 30px rgba(2,6,23,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .app{max-width:430px;margin:0 auto;min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px;padding:14px 16px}
  .brand{color:var(--brand);font-weight:800;letter-spacing:.2px}
  .back{width:30px;height:30px;border-radius:999px;display:grid;place-items:center;cursor:pointer}
  .back::before{content:"‚Üê";font-weight:700;color:var(--brand-ink)}
  .muted{color:var(--muted)}
  main{padding:14px 14px 88px}
  .title{font-weight:800;font-size:18px;margin:6px 2px 10px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:10px 2px}
  .row{display:flex;gap:10px;align-items:center}
  .stack{display:grid;gap:12px}
  input,select,textarea{width:100%;border:1px solid var(--line);border-radius:12px;padding:11px 12px;background:#fff;font:inherit}
  textarea{min-height:88px;resize:vertical}
  .btn{appearance:none;border:none;border-radius:14px;padding:12px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;box-shadow:0 10px 26px rgba(14,165,233,.25)}
  .btn.ghost{background:#f1f5f9;color:#0f172a}
  .btn.danger{background:var(--err);color:#fff}
  .person{display:flex;align-items:center;gap:12px;padding:10px;border:1px solid var(--line);border-radius:14px;cursor:pointer}
  .avatar{width:42px;height:42px;border-radius:12px;background:#f0f9ff;display:grid;place-items:center;color:var(--brand-ink);font-weight:800}
  .grow{flex:1}
  .right{display:flex;gap:8px}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#f8fafc;border:1px solid var(--line);color:#334155}
  .idea{padding:12px;cursor:pointer}
  .idea-img{width:100%;aspect-ratio:1/1;border-radius:14px;overflow:hidden;background:#f8fafc;border:1px solid var(--line)}
  .idea-img>img{width:100%;height:100%;object-fit:cover;display:block}
  .idea-title{font-weight:800;margin:10px 2px 6px}
  .idea-meta{display:flex;justify-content:space-between;color:var(--muted);font-size:14px}
  .idea-desc{margin-top:6px;color:var(--ink);opacity:.92}
  /* Product detail */
  .pd-hero{width:100%;aspect-ratio:1/1;border-radius:18px;overflow:hidden;background:#f8fafc;border:1px solid var(--line)}
  .pd-hero>img{width:100%;height:100%;object-fit:cover;display:block}
  .pd-title{font-weight:800;font-size:20px;margin-top:10px}
  .pd-meta{display:flex;justify-content:space-between;align-items:center;color:#334155;margin-top:6px}
  .pd-desc{margin-top:10px}
  nav.tabs{position:sticky;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(3,1fr)}
  .tab{padding:12px 8px;text-align:center;color:#334155;cursor:pointer;font-weight:600}
  .tab.active{color:var(--brand-ink);background:#f0f9ff}
  .empty{color:var(--muted);padding:18px}
  .hint{font-size:12px;color:var(--muted)}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .hidden{display:none !important}
  @media(prefers-color-scheme:dark){
    :root{--bg:#0b1020;--ink:#e8ecf3;--card:#0f1528;--line:#1f2538;--muted:#94a3b8;--brand:#22d3ee;--brand-ink:#06b6d4}
    .btn.ghost{background:#111827;color:#e5e7eb}
    .idea-img,.pd-hero{background:#0b1220}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="back" id="backBtn" title="Back"></div>
    <div style="display:flex;flex-direction:column">
      <div class="brand">Giftify</div>
      <div class="muted" id="status">Not logged in</div>
    </div>
    <div style="margin-left:auto" class="pill" id="apiHost"></div>
  </header>

  <main id="screens">
    <!-- AUTH -->
    <section id="auth" class="screen">
      <div class="title">Welcome</div>
      <div class="card">
        <div class="stack">
          <div class="row"><input id="authEmail" placeholder="you@example.com" /><input id="authPw" type="password" placeholder="password" /></div>
          <div class="row"><button class="btn primary" id="btnSignup">Create account</button><button class="btn ghost" id="btnLogin">Sign in</button></div>
          <div class="hint">We‚Äôll keep you signed in on this device.</div>
          <div id="authMsg" class="hint"></div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="screen hidden">
      <div class="title">Dashboard</div>
      <div class="card">
        <div class="stack">
          <div class="row" style="justify-content:space-between">
            <strong>People</strong>
            <button class="btn ghost" id="btnAddPerson">+ Add person</button>
          </div>
          <div id="peopleList"></div>
          <div id="peopleEmpty" class="empty">No people yet. Add someone to start getting gift ideas.</div>
        </div>
      </div>
    </section>

    <!-- ADD / EDIT PERSON -->
    <section id="personForm" class="screen hidden">
      <div class="title" id="personTitle">Add Person</div>
      <div class="card">
        <div class="stack">
          <input id="pName" placeholder="Name" />
          <div class="row"><input id="pBirthday" type="date" /><select id="pGender">
            <option value="">Gender (optional)</option><option>male</option><option>female</option><option>unisex</option></select>
          </div>
          <input id="pBudget" type="number" placeholder="Budget (NOK)" />
          <textarea id="pNotes" placeholder="Interests, likes, dislikes, sizes‚Ä¶ (optional)"></textarea>
          <div class="row" style="justify-content:space-between">
            <button class="btn ghost" id="btnCancelPerson">Cancel</button>
            <button class="btn primary" id="btnSavePerson">Save</button>
          </div>
        </div>
      </div>
    </section>

    <!-- GIFT IDEAS -->
    <section id="ideas" class="screen hidden">
      <div class="title" id="ideasTitle">Gift Ideas</div>
      <div class="muted" id="ideasBudget" style="margin:0 2px 10px"></div>
      <div id="ideasWrap"></div>
      <div id="ideasEmpty" class="empty">No ideas matched the budget window. Try changing the budget or notes.</div>
    </section>

    <!-- PRODUCT DETAIL -->
    <section id="productDetail" class="screen hidden">
      <div class="title" id="pdTitle">Product</div>
      <div class="card">
        <div class="pd-hero" id="pdHero"></div>
        <div class="pd-title" id="pdName"></div>
        <div class="pd-meta">
          <strong id="pdPrice"></strong>
          <span class="muted" id="pdMerchant"></span>
        </div>
        <div class="pd-desc" id="pdDesc"></div>
        <div id="pdSpecs" class="stack" style="margin-top:10px"></div>
        <div class="row" style="justify-content:flex-end;margin-top:12px">
          <button class="btn primary" id="pdBuy">Buy now</button>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="screen hidden">
      <div class="title">Profile</div>
      <div class="card">
        <div class="stack">
          <div><strong>Email:</strong> <span id="meEmail" class="muted">‚Äî</span></div>
          <div class="row" style="justify-content:space-between">
            <button class="btn ghost" id="btnRefresh">Refresh</button>
            <button class="btn danger" id="btnLogout">Log out</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- BOTTOM TABS -->
  <nav class="tabs" id="tabs">
    <div class="tab active" data-tab="dashboard">üè† Dashboard</div>
    <div class="tab" data-tab="create">Ôºã Create New</div>
    <div class="tab" data-tab="profile">üë§ Profile</div>
  </nav>
</div>

<script>
(() => {
  const API = location.origin;
  const $ = s => document.querySelector(s);
  const show = id => document.querySelectorAll('.screen').forEach(el => el.classList.toggle('hidden', el.id !== id));
  const tabsEl = $('#tabs'), backBtn = $('#backBtn'), statusEl = $('#status'), hostEl = $('#apiHost');
  hostEl.textContent = new URL(API).host;

  let token = localStorage.getItem('jwt') || '';
  let me = token ? { email: localStorage.getItem('email') || '' } : null;
  let editingId = null;
  let currentIdeas = [];
  let selectedProduct = null;

  const PEOP_KEY = 'giftify_people';
  const people = {
    list(){ try { return JSON.parse(localStorage.getItem(PEOP_KEY)||'[]'); } catch { return []; } },
    save(arr){ localStorage.setItem(PEOP_KEY, JSON.stringify(arr)); }
  };

  async function call(path, opts={}){
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers.Authorization = 'Bearer '+token;
    const res = await fetch(API+path, { ...opts, headers });
    const txt = await res.text(); try { return JSON.parse(txt) } catch { throw new Error(txt || res.statusText) }
  }
  const fmtDate = iso => { try { if(!iso) return ''; const d = new Date(iso); return d.toLocaleDateString(); } catch { return iso || '' } };

  function setAuthedUI(authed){
    $('#auth').classList.toggle('hidden', authed);
    tabsEl.classList.toggle('hidden', !authed);
    backBtn.style.visibility = 'hidden';
    statusEl.textContent = authed ? 'Signed in' : 'Not logged in';
    if (authed) { show('dashboard'); renderPeople(); } else { show('auth'); }
  }

  function renderPeople(){
    const arr = people.list();
    const listEl = $('#peopleList'); listEl.innerHTML = '';
    $('#peopleEmpty').style.display = arr.length ? 'none' : 'block';
    for (const p of arr){
      const row = document.createElement('div');
      row.className = 'person';
      row.innerHTML = `
        <div class="avatar">${(p.name||'?').slice(0,1).toUpperCase()}</div>
        <div class="grow">
          <div style="font-weight:800">${p.name}</div>
          <div class="muted">Birthday ${fmtDate(p.birthdate)}</div>
        </div>
        <div class="right"><span class="pill">${p.budget? p.budget+' NOK':''}</span></div>
      `;
      row.onclick = () => openIdeas(p);
      listEl.appendChild(row);
    }
  }

  function openAdd(){
    editingId = null;
    $('#personTitle').textContent = 'Add Person';
    $('#pName').value = ''; $('#pBirthday').value = ''; $('#pGender').value = ''; $('#pBudget').value = ''; $('#pNotes').value = '';
    show('personForm'); tabsEl.classList.add('hidden'); backBtn.style.visibility = 'visible';
  }

  function openEdit(p){
    editingId = p.id;
    $('#personTitle').textContent = 'Edit Person';
    $('#pName').value = p.name || '';
    $('#pBirthday').value = p.birthdate ? new Date(p.birthdate).toISOString().slice(0,10) : '';
    $('#pGender').value = p.gender || '';
    $('#pBudget').value = p.budget || '';
    $('#pNotes').value = p.notes || '';
    show('personForm'); tabsEl.classList.add('hidden'); backBtn.style.visibility = 'visible';
  }

  async function openIdeas(p){
    const age = p.birthdate ? Math.max(0, Math.floor((Date.now()-new Date(p.birthdate).getTime())/31557600000)) : 0;
    $('#ideasTitle').textContent = `Gift Ideas for ${p.name || ''}`;
    $('#ideasBudget').textContent = p.budget ? `Budget ${p.budget} NOK` : 'No budget set';
    $('#ideasWrap').innerHTML = ''; $('#ideasEmpty').style.display = 'none';
    show('ideas'); tabsEl.classList.add('hidden'); backBtn.style.visibility = 'visible';
    try{
      const q = new URLSearchParams({ age: age||0, gender: p.gender||'', budget: p.budget||0, notes: p.notes||'' }).toString();
      const j = await call('/ideas?'+q);
      currentIdeas = Array.isArray(j.ideas)? j.ideas : [];
      renderIdeas(currentIdeas);
    }catch(e){
      $('#ideasWrap').innerHTML = ''; $('#ideasEmpty').style.display = 'block'; $('#ideasEmpty').textContent = 'Failed to load ideas: '+e.message;
    }
  }

  function renderIdeas(list){
    const wrap = $('#ideasWrap'); wrap.innerHTML = '';
    if (!list.length){ $('#ideasEmpty').style.display = 'block'; return; }
    $('#ideasEmpty').style.display = 'none';
    for (const it of list){
      const price = Math.round(it.price_nok||0);
      const card = document.createElement('div');
      card.className = 'card idea';
      card.innerHTML = `
        <div class="idea-img">${it.image_url ? `<img src="${it.image_url}" loading="lazy" alt="">` : ''}</div>
        <div class="idea-title">${it.name||'Product'}</div>
        <div class="idea-meta">
          <strong>${price ? price+' NOK' : ''}</strong>
          <span class="muted">${it.merchant_name||''}</span>
        </div>
        ${it.description ? `<div class="idea-desc">${it.description}</div>` : ''}
      `;
      card.onclick = () => openProduct(it);
      wrap.appendChild(card);
    }
  }

  function openProduct(item){
    selectedProduct = item;
    $('#pdTitle').textContent = 'Product';
    $('#pdHero').innerHTML = item.image_url ? `<img src="${item.image_url}" alt="">` : '';
    $('#pdName').textContent = item.name || 'Product';
    $('#pdPrice').textContent = Math.round(item.price_nok||0) ? Math.round(item.price_nok)+' NOK' : '';
    $('#pdMerchant').textContent = item.merchant_name || '';
    $('#pdDesc').textContent = item.description || '';
    const specs = Array.isArray(item.specs) ? item.specs : [];
    $('#pdSpecs').innerHTML = specs.length ? specs.map(s => `<div class="row" style="justify-content:space-between"><span class="muted">${s.key}</span><strong>${s.value}</strong></div>`).join('') : '';
    show('productDetail'); tabsEl.classList.add('hidden'); backBtn.style.visibility = 'visible';
  }

  $('#pdBuy').onclick = () => {
    // Mock checkout for now
    alert('Order placed ‚úÖ\n\nThis is a test checkout. We will integrate a real provider later.');
    // Optional: you could POST /orders here if you wire it on the backend
    // Then go back to Ideas
    show('ideas'); tabsEl.classList.add('hidden'); backBtn.style.visibility = 'visible';
  };

  // Save / Cancel person
  $('#btnSavePerson').onclick = () => {
    const name = $('#pName').value.trim();
    const birthdate = $('#pBirthday').value || '';
    const gender = $('#pGender').value || '';
    const budget = Number($('#pBudget').value || 0);
    const notes = $('#pNotes').value.trim();
    if (!name || !birthdate){ alert('Please enter name and birthday'); return; }
    const arr = people.list();
    if (editingId){
      const i = arr.findIndex(x => x.id === editingId);
      if (i>=0) arr[i] = { ...arr[i], name, birthdate, gender, budget, notes };
    } else {
      const id = Date.now();
      arr.unshift({ id, name, birthdate, gender, budget, notes });
    }
    people.save(arr);
    backToDashboard();
  };
  $('#btnCancelPerson').onclick = backToDashboard;

  function backToDashboard(){ show('dashboard'); tabsEl.classList.remove('hidden'); backBtn.style.visibility = 'hidden'; renderPeople(); }

  backBtn.onclick = () => {
    const current = [...document.querySelectorAll('.screen')].find(el => !el.classList.contains('hidden'));
    if (!current) return;
    if (current.id === 'productDetail') { show('ideas'); tabsEl.classList.add('hidden'); backBtn.style.visibility = 'visible'; return; }
    if (current.id === 'ideas' || current.id === 'personForm') { backToDashboard(); return; }
    if (current.id === 'auth') return;
  };

  // Tabs
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      if (tab.dataset.tab === 'dashboard'){ show('dashboard'); tabsEl.classList.remove('hidden'); backBtn.style.visibility = 'hidden'; }
      if (tab.dataset.tab === 'create'){ openAdd(); }
      if (tab.dataset.tab === 'profile'){ show('profile'); tabsEl.classList.remove('hidden'); backBtn.style.visibility = 'hidden'; $('#meEmail').textContent = me?.email || '‚Äî'; }
    });
  });

  // Auth
  $('#btnSignup').onclick = async () => {
    const email = $('#authEmail').value.trim() || `demo+${Math.random().toString(36).slice(2)}@example.com`;
    const password = $('#authPw').value || 'demo1234';
    try{
      const j = await call('/auth/signup',{method:'POST',body:JSON.stringify({fullName:'Web User',email,password})});
      token = j.token || ''; me = { email: j.user?.email || email }; localStorage.setItem('jwt', token); localStorage.setItem('email', me.email);
      $('#authMsg').innerHTML = '<span class="ok">Account created</span>'; setAuthedUI(true);
    }catch(e){ $('#authMsg').innerHTML = '<span class="err">'+e.message+'</span>'; }
  };
  $('#btnLogin').onclick = async () => {
    const email = $('#authEmail').value.trim(); const password = $('#authPw').value;
    try{
      const j = await call('/auth/login',{method:'POST',body:JSON.stringify({email,password})});
      token = j.token || ''; me = { email: j.user?.email || email }; localStorage.setItem('jwt', token); localStorage.setItem('email', me.email);
      $('#authMsg').innerHTML = '<span class="ok">Signed in</span>'; setAuthedUI(true);
    }catch(e){ $('#authMsg').innerHTML = '<span class="err">'+e.message+'</span>'; }
  };
  $('#btnLogout').onclick = () => { token = ''; me = null; localStorage.removeItem('jwt'); localStorage.removeItem('email'); setAuthedUI(false); };
  $('#btnAddPerson').onclick = openAdd;
  $('#btnRefresh').onclick = () => location.reload();

  // boot
  setAuthedUI(!!token);
})();
</script>
</body>
</html>
